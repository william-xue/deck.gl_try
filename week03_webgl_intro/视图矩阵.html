<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>WebGL è§†å›¾çŸ©é˜µäº¤äº’è°ƒè¯•å™¨</title>
    <style>
        body { font-family: Arial, sans-serif; display: flex; flex-direction: column; align-items: center; }
        canvas { border: 1px solid #ccc; }
        #controls { margin-top: 20px; text-align: left; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
        h3 { color: #0056b3; margin-top: 0; }
        .param { margin-bottom: 12px; display: flex; align-items: center; }
        .param label { font-weight: bold; display: inline-block; width: 100px; }
        .coord-input { width: 60px; text-align: center; margin-right: 5px; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gl-matrix/2.8.1/gl-matrix-min.js"></script>
</head>
<body>
    <h1>è§†å›¾çŸ©é˜µ (View Matrix) äº¤äº’è°ƒè¯•å™¨</h1>
    <canvas id="glCanvas" width="500" height="500"></canvas>
    
    <div id="controls">
        <h3>è°ƒæ•´ç›¸æœºå‚æ•° (View Matrix)</h3>
        
        <div class="param">
            <label>Eye (ç›¸æœºä½ç½®):</label>
            X: <input type="number" id="eyeX" class="coord-input" value="5.0" step="0.5">
            Y: <input type="number" id="eyeY" class="coord-input" value="5.0" step="0.5">
            Z: <input type="number" id="eyeZ" class="coord-input" value="5.0" step="0.5">
        </div>

        <div class="param">
            <label>Center (ç›®æ ‡ç‚¹):</label>
            X: <input type="number" id="centerX" class="coord-input" value="0.0" step="0.5">
            Y: <input type="number" id="centerY" class="coord-input" value="0.0" step="0.5">
            Z: <input type="number" id="centerZ" class="coord-input" value="0.0" step="0.5">
        </div>
        
        <div class="param">
            <label>Up (å‘ä¸Šå‘é‡):</label>
            X: <input type="number" id="upX" class="coord-input" value="0.0" step="0.1">
            Y: <input type="number" id="upY" class="coord-input" value="1.0" step="0.1">
            Z: <input type="number" id="upZ" class="coord-input" value="0.0" step="0.1">
        </div>
        
        <p style="color:red;">ğŸ’¡ æ›´æ”¹å‚æ•°åï¼Œåœºæ™¯å°†è‡ªåŠ¨é‡æ–°æ¸²æŸ“ã€‚</p>
        
    </div>

    <script>
        const canvas = document.getElementById('glCanvas');
        const gl = canvas.getContext('webgl');
        
        if (!gl) {
            alert("æ— æ³•åˆå§‹åŒ– WebGLã€‚æ‚¨çš„æµè§ˆå™¨å¯èƒ½ä¸æ”¯æŒã€‚");
        }

        // --- ç€è‰²å™¨ä»£ç  (åŒä¸Šä¸€ä¸ªä¾‹å­) ---
        const vsSource = `
            attribute vec4 aVertexPosition;
            uniform mat4 uModelViewProjectionMatrix;
            void main() {
                gl_Position = uModelViewProjectionMatrix * aVertexPosition;
            }
        `;

        const fsSource = `
            precision mediump float;
            void main() {
                gl_FragColor = vec4(0.0, 0.5, 1.0, 1.0); // è“è‰²
            }
        `;
        
        function loadShader(gl, type, source) {
            const shader = gl.createShader(type);
            gl.shaderSource(shader, source);
            gl.compileShader(shader);
            return shader;
        }

        const vertexShader = loadShader(gl, gl.VERTEX_SHADER, vsSource);
        const fragmentShader = loadShader(gl, gl.FRAGMENT_SHADER, fsSource);

        const shaderProgram = gl.createProgram();
        gl.attachShader(shaderProgram, vertexShader);
        gl.attachShader(shaderProgram, fragmentShader);
        gl.linkProgram(shaderProgram);

        gl.useProgram(shaderProgram);

        function initBuffers(gl) {
            // ç«‹æ–¹ä½“é¡¶ç‚¹ (ä¸ºäº†æ›´æ¸…æ™°åœ°çœ‹åˆ°æ—‹è½¬ï¼Œæˆ‘ä»¬ç”»å‡ºå®Œæ•´çš„ç«‹æ–¹ä½“)
            const positions = [
                // Front face
                -1.0, -1.0,  1.0,  1.0, -1.0,  1.0,  1.0,  1.0,  1.0, -1.0,  1.0,  1.0,
                // Back face
                -1.0, -1.0, -1.0, -1.0,  1.0, -1.0,  1.0,  1.0, -1.0,  1.0, -1.0, -1.0,
                // Top face
                -1.0,  1.0, -1.0, -1.0,  1.0,  1.0,  1.0,  1.0,  1.0,  1.0,  1.0, -1.0,
                // Bottom face
                -1.0, -1.0, -1.0,  1.0, -1.0, -1.0,  1.0, -1.0,  1.0, -1.0, -1.0,  1.0,
                // Right face
                 1.0, -1.0, -1.0,  1.0,  1.0, -1.0,  1.0,  1.0,  1.0,  1.0, -1.0,  1.0,
                // Left face
                -1.0, -1.0, -1.0, -1.0, -1.0,  1.0, -1.0,  1.0,  1.0, -1.0,  1.0, -1.0,
            ];
            
            const indices = [
                0,  1,  2,      0,  2,  3,    // front
                4,  5,  6,      4,  6,  7,    // back
                8,  9, 10,      8, 10, 11,   // top
               12, 13, 14,     12, 14, 15,   // bottom
               16, 17, 18,     16, 18, 19,   // right
               20, 21, 22,     20, 22, 23,   // left
            ];


            const positionBuffer = gl.createBuffer();
            gl.bindBuffer(gl.ARRAY_BUFFER, positionBuffer);
            gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(positions), gl.STATIC_DRAW);

            const indexBuffer = gl.createBuffer();
            gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, indexBuffer);
            gl.bufferData(gl.ELEMENT_ARRAY_BUFFER, new Uint16Array(indices), gl.STATIC_DRAW);
            
            return {
                position: positionBuffer,
                indices: indexBuffer,
                count: indices.length
            };
        }

        const buffers = initBuffers(gl);

        const programInfo = {
            attribLocations: {
                vertexPosition: gl.getAttribLocation(shaderProgram, 'aVertexPosition'),
            },
            uniformLocations: {
                mvpMatrix: gl.getUniformLocation(shaderProgram, 'uModelViewProjectionMatrix'),
            },
        };

        gl.bindBuffer(gl.ARRAY_BUFFER, buffers.position);
        gl.vertexAttribPointer(
            programInfo.attribLocations.vertexPosition,
            3, gl.FLOAT, false, 0, 0);
        gl.enableVertexAttribArray(programInfo.attribLocations.vertexPosition);


        // --- æ ¸å¿ƒé€»è¾‘ï¼šä»è¾“å…¥æ¡†è¯»å–å‚æ•° ---
        function getVectorFromInputs(prefix) {
            // .valueAsNumber å¯ä»¥ç¡®ä¿æˆ‘ä»¬å¾—åˆ°çš„æ˜¯æ•°å­—ç±»å‹ï¼Œè€Œä¸æ˜¯å­—ç¬¦ä¸²
            const x = document.getElementById(prefix + 'X').valueAsNumber;
            const y = document.getElementById(prefix + 'Y').valueAsNumber;
            const z = document.getElementById(prefix + 'Z').valueAsNumber;
            // ç¡®ä¿ NaN (éæ•°å­—) å€¼è¢«å¤„ç†ï¼Œé¿å… WebGL é”™è¯¯
            if (isNaN(x) || isNaN(y) || isNaN(z)) {
                return [0, 0, 0]; // è¿”å›å®‰å…¨å€¼
            }
            return [x, y, z];
        }


        // --- ã€æ ¸å¿ƒæ¸²æŸ“å‡½æ•°ã€‘ ---
        function drawScene() {
            gl.clearColor(0.9, 0.9, 0.9, 1.0); 
            gl.clearDepth(1.0);
            gl.enable(gl.DEPTH_TEST);
            gl.depthFunc(gl.LEQUAL);
            gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);

            // --- ä»ç”¨æˆ·è¾“å…¥è·å– Eye, Center, Up å‘é‡ ---
            const eye = getVectorFromInputs('eye');
            const center = getVectorFromInputs('center');
            const up = getVectorFromInputs('up');

            // --- çŸ©é˜µè®¡ç®— ---
            const modelMatrix = mat4.create(); 
            const viewMatrix = mat4.create(); 
            const projectionMatrix = mat4.create();

            // P: æŠ•å½±çŸ©é˜µ
            const fieldOfView = 45 * Math.PI / 180; 
            const aspect = gl.canvas.clientWidth / gl.canvas.clientHeight;
            mat4.perspective(projectionMatrix, fieldOfView, aspect, 0.1, 100.0);

            // M: æ¨¡å‹çŸ©é˜µ (å°†ç«‹æ–¹ä½“ç§»åˆ° X=0, Y=0, Z=0)
            mat4.translate(modelMatrix, modelMatrix, [0.0, 0.0, 0.0]); 

            // V: è§†å›¾çŸ©é˜µ (æ ¸å¿ƒéƒ¨åˆ†)
            mat4.lookAt(viewMatrix, eye, center, up);

            // åˆå¹¶çŸ©é˜µ P * V * M
            const modelViewMatrix = mat4.create();
            mat4.multiply(modelViewMatrix, viewMatrix, modelMatrix); 
            
            const mvpMatrix = mat4.create();
            mat4.multiply(mvpMatrix, projectionMatrix, modelViewMatrix); 

            // ä¸Šä¼  MVP çŸ©é˜µåˆ° GPU
            gl.uniformMatrix4fv(
                programInfo.uniformLocations.mvpMatrix,
                false,
                mvpMatrix
            );

            // ç»˜åˆ¶
            gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, buffers.indices);
            gl.drawElements(gl.TRIANGLES, buffers.count, gl.UNSIGNED_SHORT, 0);
        }

        // --- äº‹ä»¶ç›‘å¬ï¼šæ¯æ¬¡è¾“å…¥æ”¹å˜æ—¶ï¼Œé‡æ–°æ¸²æŸ“åœºæ™¯ ---
        document.getElementById('controls').addEventListener('input', drawScene);

        // åˆå§‹æ¸²æŸ“
        drawScene();

    </script>
</body>
</html>